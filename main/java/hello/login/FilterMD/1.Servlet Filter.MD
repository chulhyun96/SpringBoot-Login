# 서블릿 필터

**공통 관심 사항**
다시한번 요구사항을 살펴보면, 로그인 한 사용자만 상품 관리 페이지에 들어갈 수 있어야 한다.

앞에서 로그인을 하지 않은 사용자에게는 상품 관리 버튼이 보이지 않기 때문에 문제가 없어 보인다. 그런데 문제는 로그인 하지 않은 사용자도 다음 URL을 직접 호출하면 상품 관리 화면에 들어갈 수 있다는 점이다.

그렇다면 상품 관리 컨트롤러에서 로그인 여부를 체크하는 로직을 다 작성해줘야 된다. 그러나 잘 생각해보면 **모든 컨트롤러 로직에도 공통으로 로그인 여부를 확인해야한다.** 더 큰 문제는 향후 로그인과 관련된 요구사항이 바뀌거나 로직이 변경 될 때마다, **작성해두었던 모든 로직을 다 수정해야한다.**


이러한 공통 관심사는 스프링의 AOP로도 해결할 수 있지만, 웹과 관련된 공통 관심사는**서블릿 필터 또는 스프링 인터셉터를 사용하는 것이 좋다.** 웹과 관련된 공통 관심사를 처리할 때는 HTTP의 헤더, URL의 정보들이 필요한데, 서블릿 필터 or 스프링 인터셉터는 `HttpServletRequest`를 제공한다.

즉 서블릿 필터의 사용이유는 클라이언트의 요청이 서블릿에 도달하기 전에 특정 처리를 수행하거나 혹은 서블릿의 응답이 클라이언트에 돌아가기 전에 특정 처리를 수행하기 위해 사용된다.
필터는 여러 서블릿이나 JSP 페이지에 걸쳐 반복적으로 수행되는 공통적인 작업을 캡슐화하는 용도로 사용된다.

예를 들어 웹과 관련된 요청을 처리할 때, 로그를 남긴다던가, 인증과 인가에 대한 공통적인 로직, 응답에 대한 공통적인 변경(**모든 응답에 특정 HTTP 헤더를 추가 혹은 변경**), 이미지나 혹은 다른 파일의 압축(**응답의 크기를 줄이기 위해**)
이런 일련의 공통된 작업을 필터를 통해 분리하려 관리할 수 있기 때문에 코드이 중복을 최소화 하고, 유지보수성을 높이는 것이 가능하다.

**필터의 특성**
- **필터 흐름**
    - HTTP 요청 -> WAS -> 필터 -> 서블릿 -> 컨트롤러
    - 필터를 적용하면 필터가 호출 된 다음에 디스패처 서블릿이 호출된다.
        - 만약 모든 고객의 요청 로그를 남기는 요구사항이 있다면, 필터를 사용하면 된다.
        - 필터는 특정 URL 패턴에 적용할 수 있다. `/*`이라고 하면 모든 요청에 대해 필터가 적용된다.

- **필터 제한**
    - HTTP 요청 -> WAS -> 필터 -> 서블릿 -> 컨트롤러 //로그인 사용자
    - HTTP 요청 -> WAS -> 필터(적절하지 않은 요청이라 판단, 서블릿 호출X) //비 로그인 사용자
        - 필터에서 적절하지 않은 요청이라고 판단된다면 거기에서 끝을 낼 수도 있다. 그래서 로그인 여부를 체크하기에 딱 좋다.
- **필터 체인**
    - HTTP 요청 -> WAS -> 필터1 -> 필터2 -> 필터3 -> 서블릿 -> 컨트롤러
        - 필터는 체인으로 구성되는데, 중간에 필터를 자유롭게 추가할 수 있다. 예를 들어 로그를 남기는 필터를 먼저 적용하고, 그 다음에 로그인 여부를 체크하는 필터를 만들 수 있다.


**필터 인터페이스**
```java
public interface Filter {
     public default void init(FilterConfig filterConfig) throws ServletException

 {}     public void doFilter(ServletRequest request, ServletResponse response,

             FilterChain chain) throws IOException, ServletException;
     public default void destroy() {}

}
```

필터 인터페이스를 구현하고 등록하면 서블릿 컨테이너가 필터를 싱글톤 객체로 생성하고, 관리한다.
- `init():` 필터 초기화 메서드, 서블릿 컨테이너가 생성될 때 호출된다.
- `doFilter():` 고객의 요청이 올 때 마다 해당 메서드가 호출된다. 필터의 로직을 구현하면 된다.
- `destroy():` 필터 종료 메서드, 서블릿 컨테이너가 종료될 때 호출된다.

